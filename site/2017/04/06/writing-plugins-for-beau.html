<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

	<title>Sergio Díaz  | Writing Plugins for Beau </title>
	
	<link rel="stylesheet" href="/css/screen.css">
	<link rel="alternate" type="application/rss+xml" title="RSS Feed for martianwabbit.com" href="http://feeds.feedburner.com/SeichysMissingBit" />

	<script src="/js/highlight.pack.js"></script>
</head>
<body>

<div id="top">
	<h1><a href="/">Sergio Díaz<span>.</span></a></h1>
</div>

<article>
	<h1>
		<a href="">Writing Plugins for Beau</a>
	</h1>

	<aside>
		<time>Posted on: April 06, 2017</time>
		<span>425 Words</span>
		<span>Takes 2 minutes to read</span>
	</aside>

	<p>Currently Beau allows plugins to do two different transformations. You can change the request settings right before they are used to make the request and you can transform the response after the request is finished. This covers all use cases I&#39;ve come up with so far. I&#39;ll go over the basics or writing a plugin in this post.</p>

<h2>The Plugin</h2>

<p>The first step is writing the plugin. A Beau plugin is a Javascript class that defines any of these methods: <code>preRequest(requestSettings, originalRequest)</code> and <code>postResponse(response)</code>. They can also receive settings as part of their <code>beau.yml</code>configuration. Here&#39;s the basic skeleton for a new plugin:</p>
<div class="highlight"><pre><code class="language-" data-lang="">class MyPlugin {
    constructor(settings = {}) {
        this.settings = settings;
    }

    preRequest(req, orig) {}

    postResponse(res) {}

}

module.exports = MyPlugin;
</code></pre></div>
<p>All you are missing is a basic <code>package.json</code> to finish the module (just run <code>npm init</code> and go through the steps). Once that&#39;s done you can install your plugin globally and use it as part of your <code>beau.yml</code> like this:</p>
<div class="highlight"><pre><code class="language-" data-lang="">Host: http://localhost:9000
    plugins:
        - MyPlugin:
            data:
                name: Sergio
            secret: ssh

GET /profile:
    alias: profile

GET /:
    skip_jwt: true
    alias: home
</code></pre></div>
<p>Our plugin will generate a jwt using the secret and data settings and send that along with every request. If <code>skip_jwt: true</code> is part of the request&#39;s configuration it won&#39;t attach the header. First I&#39;ll install <code>jsonwebtoken</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">npm install jsonwebtoken -S
</code></pre></div>
<p>Now all I need is to modify the preRequest so that it changes the headers and includes an Authorization with the bearer token:</p>
<div class="highlight"><pre><code class="language-" data-lang="">preRequest(req, orig) {
    let token = jwt.sign(this.settings.data || {}, this.settings.secret);

    req.headers.Authorization = `Bearer ${token}`;
}
</code></pre></div>
<p>This will attach the authorization header to every request. We should also handle the case were certain requests don&#39;t need the  header. In this case, I&#39;ll just check if the original request configuration has the field:</p>
<div class="highlight"><pre><code class="language-" data-lang="">preRequest(req, orig) {
    if (orig.skip_jwt) {
        return;
    }   

    let token = jwt.sign(this.settings.data || {}, this.settings.secret);

    req.headers.Authorization = `Bearer ${token}`;
}
</code></pre></div>
<p>That&#39;s it. Like I said before, it&#39;s pretty simple. This plugin as-is allows us for automatic token generation for certain requests. We can get as fancy or keep it as simple as we want. For now, I&#39;ll publish that plugin as <a href="https://github.com/Seich/beau-jwt">beau-jwt</a> and will make more improvements as I see fit.</p>

<h2>Conclusion</h2>

<p>Writing a plugin is pretty easy. Beau doesn&#39;t really do much so modifying requests is pretty straightforward and allows for nice, clean configuration files. Hopefully someone will think of cool things to do with these.</p>


	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'martianwabbitblog'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>

<footer>
	<p>David Sergio Díaz © All Rights Reserved.</p>
	<p>Happily hosted on <a href="http://www.webfaction.com?affiliate=seich">WebFaction</a>.</p>
</footer>

	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-2565966-9', 'auto');
		ga('send', 'pageview');
	</script>
</body>
</html>